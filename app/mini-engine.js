/*! mini-engine 2019-08-05 */

class gameObject{constructor(e){this.scene=e,this.update=this.update.bind(this),this.draw=this.draw.bind(this),this._isClicked=!1}update(e){console.log("update should be overridden")}draw(e){console.log("update should be overridden")}createAABB(e,t,n=0,i=0){return new AABB(e,t,n,i)}allowClickDetection(e){this._isClicked=!1,this._isClickTarget=this.scene.clickTarget===this,"mousedown"in this.scene.engine.mouseEvents&&this.pointInAABB(this.scene.engine.mouseEvents.mousedown,e)&&(this.scene.clickTarget=this,this.clickOffsetLeft=this.getMousePos().x-this.clickAABB.min.x,this.clickOffsetTop=this.getMousePos().y-this.clickAABB.min.y),"mouseup"in this.scene.engine.mouseEvents&&this.scene.clickTarget===this&&(this.pointInAABB(this.scene.engine.mouseEvents.mouseup,e)&&(this._isClicked=!0),this.scene.clickTarget=null)}isClicked(){return this._isClicked}isClickTarget(){return this._isClickTarget}getMousePos(){return this.scene.engine.mousePos}pointInAABB(e,t){return e.x>t.min.x&&e.x<t.max.x&&e.y>t.min.y&&e.y<t.max.y}}class AABB{constructor(e,t,n=0,i=0){this.width=e,this.height=t,this.x=n,this.y=i,this.lastPos={x:n,y:i},this.anchor=null,this.anchorPos={x:0,y:0},this.anchorees=[],this.foundCollisions=[]}get min(){return{x:this.x,y:this.y}}get max(){return{x:this.x+this.width,y:this.y+this.height}}get canvasPos(){return{x:this.x+this.anchorPos.x,y:this.y+this.anchorPos.y}}setPos(e=null,t=null){e&&(this.lastPos.x=this.x,this.x=e),t&&(this.lastPos.y=this.y,this.y=t),this.updateAnchorees()}setAnchor(e){this.anchor=e,this.anchorPos=e.canvasPos,e.anchorees.push(this)}setAnchorPos(e){this.anchorPos=e,this.updateAnchorees()}updateAnchorees(){for(var e=0;e<this.anchorees.length;e++)this.anchorees[e].setAnchorPos(this.canvasPos)}checkCollision(e){return!(this.max.x<=e.min.x||this.min.x>=e.max.x)&&!(this.max.y<=e.min.y||this.min.y>=e.max.y)}checkCollisions(e){for(var t=[],n=0;n<e.length;n++)e[n]!=this&&this.checkCollision(e[n])&&t.push(e[n]);return t}ifLeftCollision(e){return this.max.x>e.max.x}ifLeftCollisionOnly(e){return this.max.x>e.max.x&&this.min.x>e.min.x}ifRightCollision(e){return this.min.x<e.min.x}ifRightCollisionOnly(e){return this.min.x<e.min.x&&this.max.x<e.max.x}ifTopCollision(e){return this.max.y>e.max.y}ifTopCollisionOnly(e){return this.max.y>e.max.y&&this.min.y>e.min.y}ifBottomCollision(e){return this.min.y<e.min.y}ifBottomCollisionOnly(e){return this.max.y<e.max.y&&this.min.y<e.min.y}}try{module.exports=gameObject}catch(e){console.log("gameObject export failed")}class scene{constructor(e,t={}){this.engine=e,this.canvas=this.engine.canvas,this.gameObjects=[],this.layerOrder=[],this.layers={},this.setup(t)}setup(e){}switchScene(e,t){this.engine.switchScene(e,t)}update(e){for(var t=0;t<this.gameObjects.length;t++)this.gameObjects[t].update(e)}draw(e){for(var t,n=0;n<this.layerOrder.length;n++){t=this.layers[this.layerOrder[n]];for(var i=0;i<t.length;i++)t[i].draw(e)}}}try{module.exports=scene}catch(e){console.log("scene export failed")}class engine{constructor(e={},t=null,n={}){window.engine=this,this.createCanvas(),this.sceneList=e,this.currentScene=new this.sceneList[t](this,n),this.nextScene=null,this.update=this.update.bind(this),this.draw=this.draw.bind(this),this.begin=this.begin.bind(this),this.end=this.end.bind(this)}createCanvas(){this.canvas=document.getElementById("canvas"),this.context=this.canvas.getContext("2d"),this.fpsCounter=document.getElementById("fpscounter"),this.fpsValue=document.getElementById("fpsvalue"),this.canvas.width=800,this.canvas.height=400,this.mouseEvents={},this.canvas.addEventListener("click",function(e){window.engine.mouseEvents.click={x:e.x-e.target.offsetLeft,y:e.y-e.target.offsetTop}},!1),this.canvas.addEventListener("dblclick",function(e){window.engine.mouseEvents.dblclick={x:e.x-e.target.offsetLeft,y:e.y-e.target.offsetTop}},!1),this.canvas.addEventListener("mousemove",function(e){window.engine.mouseEvents.mousemove={x:e.x-e.target.offsetLeft,y:e.y-e.target.offsetTop},window.engine.mousePos=window.engine.mouseEvents.mousemove},!1),this.canvas.addEventListener("mousedown",function(e){window.engine.mouseEvents.mousedown={x:e.x-e.target.offsetLeft,y:e.y-e.target.offsetTop}},!1),this.canvas.addEventListener("contextmenu",function(e){e.preventDefault()},!1),document.addEventListener("mouseup",function(e){window.engine.mouseEvents.mouseup={x:e.x-e.target.offsetLeft,y:e.y-e.target.offsetTop}},!1),this.keyState={},this.keyPress={},this.keyUpdateCounter=0,document.addEventListener("keydown",function(e){e.keyCode in window.engine.keyState||(window.engine.keyState[e.keyCode]=0),window.engine.keyUpdateCounter=0}),document.addEventListener("keyup",function(e){window.engine.keyPress[e.keyCode]=window.engine.keyState[e.keyCode],delete window.engine.keyState[e.keyCode]})}switchScene(e,t){this.nextScene=new this.sceneList[e](this,t)}update(e){var t=!0;for(var n in this.keyState)this.keyState[n]+=e,t=!1;t||(this.keyUpdateCounter+=1),this.keyUpdateCounter>60&&(console.log("keyhold interrupted"),this.keyUpdateCounter=0,this.keyState={}),this.currentScene&&this.currentScene.update(e),this.mouseEvents={},this.keyPress={}}draw(e){this.currentScene&&(this.context.clearRect(0,0,canvas.width,canvas.height),this.currentScene.draw(e))}begin(){}end(e,t){if(this.nextScene&&(this.currentScene=this.nextScene,this.nextScene=null),this.fpsCounter.textContent=Math.round(e)+" FPS",t){var n=Math.round(MainLoop.resetFrameDelta());console.warn("Main loop panicked, probably because the browser tab was put in the background. Discarding "+n+"ms")}}start(){MainLoop.setUpdate(this.update).setDraw(this.draw).setBegin(this.begin).setEnd(this.end).start()}}try{module.exports=engine}catch(e){console.log("engine export failed")}!function(e){function t(e){if(n=x(t),!(e<o+l)){for(s+=e-o,o=e,v(e,s),e>c+a&&(h=r*u*1e3/(e-c)+(1-r)*h,c=e,u=0),u++,d=0;s>=i;)if(k(i),s-=i,++d>=240){y=!0;break}C(s/i),b(h,y),y=!1}}var n,i=1e3/60,s=0,o=0,h=60,r=.9,a=1e3,c=0,u=0,d=0,l=0,m=!1,f=!1,y=!1,g="object"==typeof window?window:e,x=g.requestAnimationFrame||function(){var e,t,n=Date.now();return function(s){return e=Date.now(),t=Math.max(0,i-(e-n)),n=e+t,setTimeout(function(){s(e+t)},t)}}(),p=g.cancelAnimationFrame||clearTimeout,w=function(){},v=w,k=w,C=w,b=w;e.MainLoop={getSimulationTimestep:function(){return i},setSimulationTimestep:function(e){return i=e,this},getFPS:function(){return h},getMaxAllowedFPS:function(){return 1e3/l},setMaxAllowedFPS:function(e){return void 0===e&&(e=1/0),0===e?this.stop():l=1e3/e,this},resetFrameDelta:function(){var e=s;return s=0,e},setBegin:function(e){return v=e||v,this},setUpdate:function(e){return k=e||k,this},setDraw:function(e){return C=e||C,this},setEnd:function(e){return b=e||b,this},start:function(){return f||(f=!0,n=x(function(e){C(1),m=!0,o=e,c=e,u=0,n=x(t)})),this},stop:function(){return m=!1,f=!1,p(n),this},isRunning:function(){return m}},"function"==typeof define&&define.amd?define(e.MainLoop):"object"==typeof module&&null!==module&&"object"==typeof module.exports&&(module.exports=e.MainLoop)}(this);